<html>
<head>
    <title>Dashboard</title>
    <style>
        table {
            border-collapse:separate;
            border-spacing:1em;
        }
        td {
            height: 40px;
            padding: 10px;
        }
        tr {
            box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.5);
            border: 1px solid black;
        }
    </style>
</head>
<body>
<table>
    <tr>
        <td>
            Running actor systems:
            <table id="mainTable"></table>
        </td>
    </tr>
</table>
<button onclick="launchVm('Pipe')" id="Pipe">Launch pipe VM</button>
<button onclick="launchVm('Avatar')" id="Avatar">Launch avatar VM</button>


<script language="javascript">
    var ws = new WebSocket("ws://" + window.location.host + "/ws");
    var mainTable = null;
    var knownInfo = {};

    ws.onmessage = function (evt) {
        var parsedData = JSON.parse(evt.data);
        switch (parsedData.t) {
            case "ShardMetrics":
                console.log("ShardMetrics: " + parsedData.metrics);
                break;

            case "MemoryMetrics":
                if (addrString(parsedData.address) in knownInfo) {
                    knownInfo[addrString(parsedData.address)].mem = Math.round(parsedData.usedHeap);
                } else {
                    knownInfo[addrString(parsedData.address)] = { mem: Math.round(parsedData.usedHeap), cpu: null};
                }
                refillTable(mainTable, knownInfo);
                console.log("MemoryMetrics: " + addrString(parsedData.address) + " - " +
                        parsedData.usedHeap);
                break;

            case "CpuMetrics":
                if (addrString(parsedData.address) in knownInfo) {
                    knownInfo[addrString(parsedData.address)].cpu = parsedData.average + "/" + parsedData.processors;
                } else {
                    knownInfo[addrString(parsedData.address)] = { mem: null, cpu: parsedData.average + "/" + parsedData.processors};
                }
                refillTable(mainTable, knownInfo);
                console.log("CpuMetrics: " + addrString(parsedData.address) + " - " +
                        parsedData.average + "/" + parsedData.processors);
                break;

            case "DdataStatus":
                console.log("DdataStatus: " + parsedData.data);
                break;

            case "Launched":
                document.getElementById(parsedData.image).disabled = false;

            default:
                console.log(parsedData);
        }
    };

    function addrString(address) {
        return address.protocol + "://" + address.system + "@" + address.host + ":" + address.port;
    }

    function refillTable(table, knownInfo) {
        for(var i = 0; i < table.rows.length;) {
            table.deleteRow(i);
        }
        for(var info in knownInfo) {
            insertCpuMemIntoTable(info + "   CPU: " + knownInfo[info].cpu + "  MEM: " + knownInfo[info].mem + "MB", table)
        }
    }

    function insertCpuMemIntoTable(cpumem, table) {
        var tr = document.createElement('TR');
        var td = document.createElement('TD');
        td.textContent = cpumem;
        tr.appendChild(td);
        table.appendChild(tr);
    }

    function launchVm(image) {
        document.getElementById(image).disabled = true;
        ws.send(JSON.stringify({t: "Launch", image: image}));
    }

    ws.onopen = function (evt) {
        mainTable = document.getElementById("mainTable");
    };
</script>
</body>
</html>